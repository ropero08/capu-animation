function renderDists(){
  const container = $('distsContainer');
  container.innerHTML='';
  const email = localStorage.getItem('capu_current');
  let user = users[email];
  
  if(user.dists.length===0){
    user.dists = [
      {id:1,title:'Sección 1',text:'',media:[]},
      {id:2,title:'Sección 2',text:'',media:[]},
      {id:3,title:'Sección 3',text:'',media:[]}
    ];
  }
  localStorage.setItem('capu_users',JSON.stringify(users));

  user.dists.forEach((d,idx)=>{
    const box = document.createElement('div'); 
    box.className='dist';
    box.innerHTML=`
      <div class="hdr">
        <h3 contenteditable="true" class="dist-title">${d.title}</h3>
      </div>
      <textarea class="desc" placeholder="Descripción...">${d.text}</textarea>
      <div class="file-row">
        <label>Subir video<input type="file" accept="video/*" style="display:none" class="video-up"></label>
        <label>Subir PDF<input type="file" accept="application/pdf" style="display:none" class="pdf-up"></label>
        <button class="small-btn save-dist">Guardar</button>
      </div>
      <div class="preview-video"></div>
      <div class="preview-pdf"></div>
    `;
    container.appendChild(box);

    const videoUp = box.querySelector('.video-up');
    const pdfUp = box.querySelector('.pdf-up');
    const saveBtn = box.querySelector('.save-dist');
    const previewVideo = box.querySelector('.preview-video');
    const previewPdf = box.querySelector('.preview-pdf');

    function paintMedia(){
      previewVideo.innerHTML='';
      previewPdf.innerHTML='';
      (d.media||[]).forEach(m=>{
        if(m.type==='video'){
          const v=document.createElement('video');
          v.controls=true;
          v.src=m.url;
          v.style.width='100%';
          v.style.marginBottom='8px';
          previewVideo.appendChild(v);
        }
        if(m.type==='pdf'){
          const a=document.createElement('a');
          a.href=m.url;
          a.target='_blank';
          a.textContent='Abrir PDF';
          a.style.display='block';
          a.style.color='blue';
          a.style.textDecoration='underline';
          a.style.marginBottom='8px';
          previewPdf.appendChild(a);
        }
      });
    }
    paintMedia();

    videoUp.addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'video',url});
      saveAndRerender();
    });
    pdfUp.addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'pdf',url});
      saveAndRerender();
    });
    saveBtn.addEventListener('click',()=>{
      d.title = box.querySelector('.dist-title').textContent.trim();
      d.text = box.querySelector('.desc').value.trim();
      saveAndRerender();
      alert('Sección guardada');
    });

    function saveAndRerender(){
      users[email].dists[idx]=d;
      localStorage.setItem('capu_users',JSON.stringify(users));
      renderDists();
    }
  });
}
