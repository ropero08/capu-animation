<script>
// =========================
//   ┓ SECCIONES (3 DIST)
// =========================

function renderDists(){
  const container = document.getElementById('distsContainer');
  container.innerHTML='';

  const email = localStorage.getItem('capu_current');
  let user = users[email];

  if(!user.dists || user.dists.length === 0){
    user.dists = [
      {id:1, title:'Secci贸n 1', text:'', media:[]},
      {id:2, title:'Secci贸n 2', text:'', media:[]},
      {id:3, title:'Secci贸n 3', text:'', media:[]}
    ];
  }

  localStorage.setItem('capu_users',JSON.stringify(users));

  user.dists.forEach((d,idx)=>{

    const box = document.createElement('div');
    box.className='dist';

    box.innerHTML = `
      <div class="hdr">
        <h3 contenteditable="true" class="dist-title">${d.title}</h3>
      </div>

      <textarea class="desc">${d.text}</textarea>

      <div class="file-row">
        <label>
          Subir video
          <input type="file" accept="video/*" class="video-up" style="display:none">
        </label>

        <label>
          Subir PDF
          <input type="file" accept="application/pdf" class="pdf-up" style="display:none">
        </label>

        <button class="small-btn save-dist">Guardar</button>
      </div>

      <div class="preview"></div>
    `;

    container.appendChild(box);

    const videoUp = box.querySelector('.video-up');
    const pdfUp = box.querySelector('.pdf-up');
    const saveBtn = box.querySelector('.save-dist');
    const preview = box.querySelector('.preview');

    function paintMedia(){
      preview.innerHTML = '';
      d.media.forEach(m=>{
        if(m.type === 'video'){
          const v = document.createElement('video');
          v.controls = true;
          v.src = m.url;
          preview.appendChild(v);
        }
        if(m.type === 'pdf'){
          const p = document.createElement('iframe');
          p.src = m.url;
          p.style.height = '200px';
          preview.appendChild(p);
        }
      });
    }

    paintMedia();

    videoUp.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'video', url});
      saveSec();
    });

    pdfUp.addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'pdf', url});
      saveSec();
    });

    saveBtn.addEventListener('click',()=>{
      d.title = box.querySelector('.dist-title').textContent.trim();
      d.text = box.querySelector('.desc').value.trim();
      saveSec();
      alert('Secci贸n guardada ');
    });

    function saveSec(){
      users[email].dists[idx] = d;
      localStorage.setItem('capu_users',JSON.stringify(users));
      renderDists();
    }
  });
}
</script>
