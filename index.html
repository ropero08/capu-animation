<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CAPU Animation</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#5b3f5b;
  --muted:#6b6464;
  --card:#ffffff;
  --soft-bg: rgba(255,255,255,0.92);
  --accent1:#f5d6e6;
  --accent2:#e8f2fb;
  --round:14px;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Roboto,Arial;color:var(--primary);background:linear-gradient(180deg,#fffaf6,#fff1e6);}

/* LANDING / LOGIN */
#landing-wrap{
  position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(180deg,#fffaf6,#fff1e6); background-size:cover; background-position:center;
}
#landing-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.18));backdrop-filter: blur(3px);}
.card-join{position:relative; z-index:2; width:92%; max-width:640px; padding:36px; border-radius:18px; background:var(--soft-bg); box-shadow:0 18px 50px rgba(20,10,30,0.12); text-align:center;}
.title{font-family:'Playfair Display',serif;font-size:42px;color:var(--primary);margin:0 0 6px 0}
.lead{color:var(--muted);margin-bottom:16px;font-size:15px}
.input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #efe6ee;margin-top:10px;font-size:15px}
.btn{display:inline-block;padding:12px 20px;border-radius:12px;background:linear-gradient(180deg,var(--accent1),#f1cfe1);border:none;font-weight:600;cursor:pointer;color:#3a233a;margin-top:14px;box-shadow:0 8px 22px rgba(100,60,100,0.08)}
.btn:hover{transform:translateY(-3px)}
.small-tip{font-size:13px;color:var(--muted);margin-top:12px}

/* APP HEADER */
header.app-header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(255,255,255,0.95);position:sticky;top:0;z-index:60;backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(20,10,30,0.04)}
.logo-left{display:flex;align-items:center;gap:12px}
.logo-text{font-weight:700;font-size:20px;color:var(--primary);font-family:'Playfair Display',serif}
.user-area{display:flex;align-items:center;gap:12px}
.username{font-weight:600;color:var(--muted);font-size:14px}
.avatar{width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid rgba(0,0,0,0.06);cursor:pointer}
.avatar img{width:100%;height:100%;object-fit:cover}

/* Layout */
.container{max-width:1100px;margin:22px auto;padding:0 18px}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(20,10,30,0.04)}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px;align-items:start}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

/* Distribution */
.dist{padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),#fff);min-height:260px;display:flex;flex-direction:column;gap:10px}
.dist .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px}
.dist h3{margin:0;font-size:18px}
.desc{flex:1;margin-top:8px;padding:10px;border-radius:10px;border:1px solid #f0e7f1;min-height:70px;resize:vertical}
.file-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.file-row label{background:#fff;border:1px solid #efe6ee;padding:8px 10px;border-radius:10px;cursor:pointer}
.preview{margin-top:8px;border-radius:10px;overflow:hidden;background:#faf7fb;padding:8px;border:1px dashed #efe6ee}
.preview video,.preview iframe,.preview img{width:100%;height:auto;display:block;border-radius:8px}

/* Edit panel small */
.edit-panel{position:fixed;right:18px;bottom:18px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(20,10,40,0.08);width:260px;z-index:80;transition:transform .18s ease,opacity .18s ease}
.edit-panel.hidden{transform:translateY(18px);opacity:0.02;pointer-events:none}
.edit-panel input[type=color], .edit-panel input[type=file]{display:block;margin:8px 0;width:100%}
.edit-panel .tiny{font-size:13px;color:var(--muted);margin-top:6px}
.small-btn{padding:8px 10px;border-radius:10px;border:1px solid #efe6ee;background:#fff;cursor:pointer}

/* footer */
.footer{text-align:center;color:var(--muted);padding:28px 0}

/* focus */
input:focus, textarea:focus, button:focus { outline: 3px solid rgba(165,122,166,0.12); outline-offset:3px }

/* DEBUG overlay (hidden by default) */
#debugOverlay{position:fixed;inset:12px;background:rgba(0,0,0,0.6);color:white;display:none;z-index:9999;padding:20px;border-radius:12px;overflow:auto}
#debugOverlay pre{white-space:pre-wrap;font-size:13px}
</style>
</head>
<body>

<div id="landing-wrap">
  <div id="landing-overlay"></div>
  <div class="card-join">
    <div class="title">CAPU ANIMATION</div>
    <div class="lead">Comparte animaciones, formaciÃ³n y devociÃ³n en tonos delicados</div>

    <!-- LOGIN -->
    <input class="input" type="email" id="loginEmail" placeholder="Correo">
    <button class="btn" id="btnLogin">Entrar</button>
    <hr>

    <!-- REGISTER -->
    <input id="regName" class="input" type="text" placeholder="Tu nombre completo">
    <input id="regEmail" class="input" type="email" placeholder="Tu correo (Gmail)">
    <button class="btn" id="btnRegister">Crear cuenta y entrar</button>
    <div class="small-tip">Personaliza el fondo desde el panel ðŸŽ¨ (se aplicarÃ¡ en la pÃ¡gina principal).</div>
  </div>
</div>

<header class="app-header" id="appHeader" style="display:none">
  <div class="logo-left"><div class="logo-text">CAPU <span style="color:#a57aa6">Animation</span></div></div>
  <div class="user-area">
    <div class="username" id="displayName"></div>
    <div class="avatar" id="avatarWrap"><img id="avatarImg" src="https://via.placeholder.com/120?text=U"></div>
  </div>
  <button id="openPanelHeader" class="small-btn">ðŸŽ¨</button>
  <button id="logoutBtn" class="small-btn">Salir</button>
</header>

<main id="appMain" style="display:none">
  <div class="container">
    <section class="card" aria-label="Bienvenida">
      <h2>Bienvenid@, <span id="welcomeName" style="font-weight:700"></span></h2>
      <p style="color:var(--muted)">Crea distribuciones, sube video y PDF y verÃ¡s una vista previa inmediata.</p>
    </section>

    <section class="card">
      <h3>Secciones principales</h3>
      <div class="grid" id="distsContainer"></div>
    </section>

    <footer class="footer">CAPU Animation â€” Guardado en tu navegador</footer>
  </div>
</main>

<div class="edit-panel hidden" id="editPanel">
  <div style="font-weight:700">ðŸŽ¨ Personalizar</div>
  <div class="tiny">Fondo</div>
  <input type="file" id="bgFile" accept="image/*">
  <input type="color" id="bgColor" value="#ffffff">
  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="small-btn" id="applyBg">Aplicar</button>
    <button class="small-btn" id="previewBg">Vista previa</button>
    <button class="small-btn" id="clearBg">Quitar</button>
  </div>
  <hr>
  <div class="tiny">Avatar</div>
  <input type="file" id="avatarFile" accept="image/*">
  <div style="display:flex;gap:8px;margin-top:8px">
    <button class="small-btn" id="saveStyles">Guardar</button>
    <button class="small-btn" id="resetStyles">Reset</button>
  </div>
</div>

<!-- Debug overlay -->
<div id="debugOverlay"><h3>Error detectado</h3><pre id="debugText"></pre><button onclick="document.getElementById('debugOverlay').style.display='none'">Cerrar</button></div>

<script>
/*
  VersiÃ³n robusta del script: evita errores que dejen la pantalla en blanco.
  - Comprueba existencia de elementos antes de aÃ±adir event listeners.
  - Captura errores globales y muestra debugOverlay en vez de pantalla en blanco.
  - Asegura renderDists() se llama tras iniciar sesiÃ³n.
*/

(function(){
  // global error handler: show overlay instead de pantalla blanca
  window.addEventListener('error', function(e){
    try {
      const overlay = document.getElementById('debugOverlay');
      const txt = document.getElementById('debugText');
      overlay.style.display = 'block';
      txt.textContent = 'Error: ' + (e && e.message ? e.message : JSON.stringify(e)) + '\n\nStack:\n' + (e.error && e.error.stack ? e.error.stack : 'no stack');
    } catch(err){
      console.error('Error handler failed', err);
    }
    console.error(e);
  });

  const $ = id => document.getElementById(id);
  let users = {};
  try{ users = JSON.parse(localStorage.getItem('capu_users') || '{}'); } catch(e){ users = {}; }

  // safe addEvent helper
  function safeOn(el, evt, fn){
    if(!el) return;
    el.addEventListener(evt, fn);
  }

  // register/login wiring (safe)
  safeOn($('btnRegister'), 'click', register);
  safeOn($('btnLogin'), 'click', login);
  safeOn($('logoutBtn'), 'click', logout);
  safeOn($('openPanelHeader'), 'click', ()=>{ const p=$('editPanel'); if(p) p.classList.toggle('hidden'); });

  function register(){
    try{
      const name = $('regName').value.trim();
      const email = $('regEmail').value.trim().toLowerCase();
      if(!name || !email) return alert('Completa los campos');
      if(users[email]) return alert('Usuario ya existe');
      users[email] = {name,email,avatar:null,dists:[]};
      localStorage.setItem('capu_users',JSON.stringify(users));
      localStorage.setItem('capu_current',email);
      initApp();
    } catch(e){ console.error(e); alert('Error al registrar'); }
  }

  function login(){
    try{
      const email = $('loginEmail').value.trim().toLowerCase();
      if(!users[email]) return alert('Usuario no existe');
      localStorage.setItem('capu_current',email);
      initApp();
    } catch(e){ console.error(e); alert('Error al iniciar sesiÃ³n'); }
  }

  function logout(){
    localStorage.removeItem('capu_current');
    location.reload();
  }

  function initApp(){
    try{
      const email = localStorage.getItem('capu_current');
      if(!email || !users[email]){
        // ensure landing remains visible if no session
        $('landing-wrap') && ($('landing-wrap').style.display='flex');
        $('appHeader') && ($('appHeader').style.display='none');
        $('appMain') && ($('appMain').style.display='none');
        return;
      }
      const user = users[email];
      // show app
      $('landing-wrap') && ($('landing-wrap').style.display='none');
      $('appHeader') && ($('appHeader').style.display='flex');
      $('appMain') && ($('appMain').style.display='block');

      // fill header
      if($('welcomeName')) $('welcomeName').textContent = user.name || '';
      if($('displayName')) $('displayName').textContent = user.name || '';
      if($('avatarImg')) $('avatarImg').src = user.avatar || 'https://via.placeholder.com/120?text=U';

      // IMPORTANT: call render
      if(typeof renderDists === 'function') renderDists();
    } catch(e){ console.error(e); throw e; }
  }

  // renderDists - robust version
  function renderDists(){
    try{
      const container = $('distsContainer');
      if(!container) return;
      container.innerHTML = '';
      const email = localStorage.getItem('capu_current');
      if(!email || !users[email]) return;
      const user = users[email];

      if(!user.dists || user.dists.length === 0){
        user.dists = [
          {id:1,title:'SecciÃ³n 1',text:'',media:[]},
          {id:2,title:'SecciÃ³n 2',text:'',media:[]},
          {id:3,title:'SecciÃ³n 3',text:'',media:[]}
        ];
      }

      // persist (safe)
      try{ localStorage.setItem('capu_users', JSON.stringify(users)); }catch(e){console.warn('Could not persist users',e);}

      user.dists.forEach((d,idx)=>{
        const box = document.createElement('div');
        box.className = 'dist';
        box.innerHTML = `
          <div class="hdr"><h3 contenteditable="true" class="dist-title">${escapeHtml(d.title)}</h3></div>
          <textarea class="desc">${escapeHtml(d.text||'')}</textarea>
          <div class="file-row">
            <label>Subir video<input type="file" accept="video/*" style="display:none" class="video-up"></label>
            <label>Subir PDF<input type="file" accept="application/pdf" style="display:none" class="pdf-up"></label>
            <button class="small-btn save-dist">Guardar</button>
          </div>
          <div class="preview"></div>
        `;
        container.appendChild(box);

        const videoUp = box.querySelector('.video-up');
        const pdfUp = box.querySelector('.pdf-up');
        const saveBtn = box.querySelector('.save-dist');
        const preview = box.querySelector('.preview');

        function paintMedia(){
          preview.innerHTML = '';
          (d.media || []).forEach(m=>{
            if(m.type === 'video'){
              const v = document.createElement('video');
              v.controls = true; v.src = m.url; v.style.maxHeight='260px'; v.style.width='100%';
              preview.appendChild(v);
            }
            if(m.type === 'pdf'){
              // show link instead of iframe for better safety
              const a = document.createElement('a');
              a.href = m.url; a.target = '_blank'; a.textContent = 'ðŸ“„ Abrir PDF';
              a.className = 'pdf-link';
              preview.appendChild(a);
            }
          });
        }
        paintMedia();

        safeOn(videoUp, 'change', e=>{
          const f = e.target.files[0]; if(!f) return;
          const url = URL.createObjectURL(f);
          d.media = d.media || []; d.media.push({type:'video', url});
          saveAndRerender();
        });
        safeOn(pdfUp, 'change', e=>{
          const f = e.target.files[0]; if(!f) return;
          const url = URL.createObjectURL(f);
          d.media = d.media || []; d.media.push({type:'pdf', url});
          saveAndRerender();
        });
        safeOn(saveBtn, 'click', ()=>{
          d.title = box.querySelector('.dist-title').textContent.trim();
          d.text = box.querySelector('.desc').value.trim();
          saveAndRerender();
          alert('SecciÃ³n guardada');
        });

        function saveAndRerender(){
          users[localStorage.getItem('capu_current')].dists[idx] = d;
          try{ localStorage.setItem('capu_users', JSON.stringify(users)); }catch(e){console.warn(e);}
          // re-render safely
          setTimeout(()=>{ try{ renderDists(); } catch(e){ console.error(e); } }, 50);
        }
      });
    } catch(e){ console.error('renderDists error', e); throw e; }
  }

  // helper escape to avoid injecting raw HTML into editable titles
  function escapeHtml(str){
    if(!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // Avatar handling (safe)
  safeOn($('avatarFile'), 'change', (ev)=>{
    const f = ev.target.files ? ev.target.files[0] : null;
    if(!f) return;
    const fr = new FileReader();
    fr.onload = ()=> {
      $('avatarImg') && ($('avatarImg').src = fr.result);
      const email = localStorage.getItem('capu_current');
      if(email && users[email]){ users[email].avatar = fr.result; try{ localStorage.setItem('capu_users', JSON.stringify(users)); }catch(e){} }
    };
    fr.readAsDataURL(f);
  });
  safeOn($('avatarWrap'), 'click', ()=>{ const el = $('avatarFile'); if(el) el.click(); });

  // Background handlers
  let stagedBg = {img:null,color:null};
  safeOn($('bgFile'), 'change', ev=>{
    const f = ev.target.files ? ev.target.files[0] : null; if(!f) return;
    const fr = new FileReader();
    fr.onload=()=>{ stagedBg.img=fr.result; alert('Imagen cargada. Vista previa o Aplicar.'); };
    fr.readAsDataURL(f);
  });
  safeOn($('bgColor'), 'input', ev=> stagedBg.color = ev.target.value );
  safeOn($('previewBg'), 'click', ()=>{
    if(stagedBg.img) $('landing-wrap') && ($('landing-wrap').style.backgroundImage = `url('${stagedBg.img}')`);
    else if(stagedBg.color) $('landing-wrap') && ($('landing-wrap').style.background = stagedBg.color);
  });
  safeOn($('applyBg'), 'click', ()=>{
    if(stagedBg.img){ localStorage.setItem('capu_bg', stagedBg.img); $('landing-wrap') && ($('landing-wrap').style.backgroundImage = `url('${stagedBg.img}')`); }
    else if(stagedBg.color){ localStorage.setItem('capu_bg_color', stagedBg.color); $('landing-wrap') && ($('landing-wrap').style.background = stagedBg.color); }
  });
  safeOn($('clearBg'), 'click', ()=>{
    localStorage.removeItem('capu_bg'); localStorage.removeItem('capu_bg_color');
    $('landing-wrap') && ($('landing-wrap').style.background = 'linear-gradient(180deg,#fffaf6,#fff1e6)');
    $('landing-wrap') && ($('landing-wrap').style.backgroundImage = '');
    stagedBg = {img:null,color:null};
    if($('bgFile')) $('bgFile').value='';
    if($('bgColor')) $('bgColor').value='#ffffff';
  });
  safeOn($('saveStyles'), 'click', ()=> alert('Estilos guardados en tu navegador. Pulsa Aplicar.'));
  safeOn($('resetStyles'), 'click', ()=>{ localStorage.removeItem('capu_bg'); localStorage.removeItem('capu_bg_color'); location.reload(); });

  // On load: restore bg and init if session
  window.addEventListener('load', ()=>{
    try{
      const bg = localStorage.getItem('capu_bg');
      const bgc = localStorage.getItem('capu_bg_color');
      if(bg && $('landing-wrap')) $('landing-wrap').style.backgroundImage = `url('${bg}')`;
      if(bgc && $('landing-wrap')) $('landing-wrap').style.background = bgc;
      if(localStorage.getItem('capu_current')) initApp();
    } catch(e){ console.error(e); }
  });

  // expose for debugging if needed
  window._capu = { users, renderDists, initApp };

})();
</script>

</body>
</html>
