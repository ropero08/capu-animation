<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAPU Animation</title>
<style>
  body {margin:0;font-family:sans-serif;background:#f5f5f5;}
  #login-register, #app {display:none;}
  .card{background:white;padding:20px;border-radius:12px;max-width:400px;margin:40px auto;box-shadow:0 5px 20px rgba(0,0,0,0.1);}
  input, button{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:1px solid #ccc;}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  .avatar img{width:50px;height:50px;border-radius:50%;}
  .sections{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;margin:20px;}
  .section{background:white;padding:10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  #editPanel{position:fixed;bottom:10px;right:10px;background:white;padding:10px;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.2);}
</style>
</head>
<body>

<!-- LOGIN / REGISTER -->
<div id="login-register">
  <div class="card">
    <h2>Iniciar Sesión</h2>
    <input type="email" id="loginEmail" placeholder="Correo">
    <button onclick="login()">Entrar</button>
    <hr>
    <h2>Crear Cuenta</h2>
    <input type="text" id="regName" placeholder="Nombre completo">
    <input type="email" id="regEmail" placeholder="Correo">
    <button onclick="register()">Crear Cuenta</button>
  </div>
</div>

<!-- APP PRINCIPAL -->
<div id="app">
  <header>
    <div class="user-info">
      <span id="userName"></span>
      <div class="avatar" onclick="changeAvatar()"><img id="avatarImg" src="https://via.placeholder.com/50"></div>
    </div>
    <div class="app-name">CAPU Animation</div>
    <button onclick="logout()">Salir</button>
  </header>
  
  <div class="sections" id="sectionsContainer">
    <!-- Secciones de texto, video, PDF -->
  </div>

  <div id="editPanel">
    <h4>Personalización</h4>
    Fondo: <input type="color" id="bgColor"><br>
    Imagen: <input type="file" id="bgFile"><br>
    <button onclick="applyBackground()">Aplicar Fondo</button>
    <hr>
    Avatar: <input type="file" id="avatarFile" onchange="uploadAvatar(this)">
  </div>
</div>

<script>
let users = JSON.parse(localStorage.getItem('users')||'{}');
let currentUser = localStorage.getItem('currentUser');

function showLogin(){document.getElementById('login-register').style.display='block';document.getElementById('app').style.display='none';}
function showApp(){document.getElementById('login-register').style.display='none';document.getElementById('app').style.display='block';renderUser();renderSections();applySavedBackground();}

function register(){
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  if(!name||!email){alert('Completa los campos'); return;}
  if(users[email]){alert('Usuario ya existe'); return;}
  users[email] = {name,email,avatar:null,sections:[]};
  localStorage.setItem('users',JSON.stringify(users));
  localStorage.setItem('currentUser',email);
  showApp();
}

function login(){
  const email = document.getElementById('loginEmail').value;
  if(!users[email]){alert('Usuario no existe'); return;}
  localStorage.setItem('currentUser',email);
  showApp();
}

function logout(){
  localStorage.removeItem('currentUser');
  showLogin();
}

// Render usuario y avatar
function renderUser(){
  const user = users[localStorage.getItem('currentUser')];
  document.getElementById('userName').textContent = user.name;
  document.getElementById('avatarImg').src = user.avatar || 'https://via.placeholder.com/50';
}

// Avatar
function changeAvatar(){
  document.getElementById('avatarFile').click();
}
function uploadAvatar(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=function(){ 
    users[currentUser].avatar = reader.result;
    localStorage.setItem('users',JSON.stringify(users));
    document.getElementById('avatarImg').src = reader.result;
  }
  reader.readAsDataURL(file);
}

// Secciones de texto, video y PDF
function renderSections(){
  const container = document.getElementById('sectionsContainer');
  container.innerHTML='';
  const user = users[currentUser];
  if(user.sections.length===0){
    user.sections.push({title:'Sección 1',text:'',media:[]});
    user.sections.push({title:'Sección 2',text:'',media:[]});
  }
  user.sections.forEach((s,idx)=>{
    const div = document.createElement('div'); div.className='section';
    div.innerHTML=`
      <h3 contenteditable="true">${s.title}</h3>
      <textarea placeholder="Texto">${s.text}</textarea>
      <input type="file" accept="video/*,application/pdf" onchange="uploadMedia(event,${idx})"><br>
      <div class="mediaPreview">${s.media.map(m=>m.type==='video'?'<video controls src="'+m.url+'"></video>':'<a href="'+m.url+'" target="_blank">PDF</a>').join('')}</div>
      <button onclick="saveSection(${idx})">Guardar</button>
    `;
    container.appendChild(div);
  });
}

function uploadMedia(event,idx){
  const file = event.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  const type = file.type.includes('video') ? 'video':'pdf';
  users[currentUser].sections[idx].media.push({url,type});
  localStorage.setItem('users',JSON.stringify(users));
  renderSections();
}

function saveSection(idx){
  const container = document.getElementById('sectionsContainer');
  const div = container.children[idx];
  users[currentUser].sections[idx].title = div.querySelector('h3').textContent;
  users[currentUser].sections[idx].text = div.querySelector('textarea').value;
  localStorage.setItem('users',JSON.stringify(users));
  alert('Sección guardada');
}

// Fondo
function applyBackground(){
  const color = document.getElementById('bgColor').value;
  const file = document.getElementById('bgFile').files[0];
  if(file){
    const reader = new FileReader();
    reader.onload=function(){
      document.body.style.backgroundImage = `url('${reader.result}')`;
      localStorage.setItem('bg',reader.result);
    }
    reader.readAsDataURL(file);
  } else {
    document.body.style.background=color;
    localStorage.setItem('bg',color);
  }
}

function applySavedBackground(){
  const bg = localStorage.getItem('bg');
  if(bg){
    if(bg.startsWith('#')) document.body.style.background=bg;
    else document.body.style.backgroundImage=`url('${bg}')`;
  }
}

// Inicial
if(currentUser){showApp();} else {showLogin();}
</script>

</body>
</html>
