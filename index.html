<script>
const $ = id => document.getElementById(id);

// Cargar usuarios desde localStorage
let users = JSON.parse(localStorage.getItem('capu_users') || '{}');

// REGISTRAR
function register() {
  const name = $('regName').value.trim();
  const email = $('regEmail').value.trim();
  if(!name || !email) return alert('Completa los campos');
  if(users[email]) return alert('Usuario ya existe');

  users[email] = {name,email,avatar:null,dists:[]};
  localStorage.setItem('capu_users', JSON.stringify(users));
  localStorage.setItem('capu_current', email);
  initApp();
}

// LOGIN
function login() {
  const email = $('loginEmail').value.trim();
  if(!users[email]) return alert('Usuario no existe');
  localStorage.setItem('capu_current', email);
  initApp();
}

// LOGOUT
function logout() {
  localStorage.removeItem('capu_current');
  location.reload();
}

// INICIAR APP
function initApp() {
  const email = localStorage.getItem('capu_current');
  if(!email) return;
  const user = users[email];

  $('landing-wrap').style.display = 'none';
  $('appHeader').style.display = '';
  $('appMain').style.display = '';
  $('welcomeName').textContent = user.name;
  $('displayName').textContent = user.name;
  $('avatarImg').src = user.avatar || 'https://via.placeholder.com/120?text=U';

  renderDists();
}

// RENDER SECCIONES
function renderDists() {
  const container = $('distsContainer');
  container.innerHTML = '';
  const email = localStorage.getItem('capu_current');
  let user = users[email];

  if(user.dists.length === 0){
    user.dists = [
      {id:1,title:'Secci贸n 1',text:'',media:[]},
      {id:2,title:'Secci贸n 2',text:'',media:[]},
      {id:3,title:'Secci贸n 3',text:'',media:[]}
    ];
  }

  localStorage.setItem('capu_users', JSON.stringify(users));

  user.dists.forEach((d, idx) => {
    const box = document.createElement('div');
    box.className = 'dist';
    box.innerHTML = `
      <div class="hdr"><h3 contenteditable="true" class="dist-title">${d.title}</h3></div>
      <textarea class="desc">${d.text}</textarea>
      <div class="file-row">
        <label>Subir video<input type="file" accept="video/*" style="display:none" class="video-up"></label>
        <label>Subir PDF<input type="file" accept="application/pdf" style="display:none" class="pdf-up"></label>
        <button class="small-btn save-dist">Guardar</button>
      </div>
      <div class="preview"></div>
    `;
    container.appendChild(box);

    const videoUp = box.querySelector('.video-up');
    const pdfUp = box.querySelector('.pdf-up');
    const saveBtn = box.querySelector('.save-dist');
    const preview = box.querySelector('.preview');

    function paintMedia() {
      preview.innerHTML = '';
      (d.media || []).forEach(m => {
        if(m.type === 'video'){
          const v = document.createElement('video');
          v.controls = true;
          v.src = m.url;
          preview.appendChild(v);
        }
        if(m.type === 'pdf'){
          const iframe = document.createElement('iframe');
          iframe.src = m.url;
          iframe.style.height = '200px';
          preview.appendChild(iframe);
        }
      });
    }
    paintMedia();

    videoUp.addEventListener('change', ev => {
      const f = ev.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'video',url});
      saveAndRerender();
    });

    pdfUp.addEventListener('change', ev => {
      const f = ev.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      d.media.push({type:'pdf',url});
      saveAndRerender();
    });

    saveBtn.addEventListener('click', () => {
      d.title = box.querySelector('.dist-title').textContent.trim();
      d.text = box.querySelector('.desc').value.trim();
      saveAndRerender();
      alert('Secci贸n guardada');
    });

    function saveAndRerender() {
      users[email].dists[idx] = d;
      localStorage.setItem('capu_users', JSON.stringify(users));
      renderDists();
    }
  });
}

// AVATAR
$('avatarFile').addEventListener('change', (ev) => {
  const f = ev.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = () => {
    $('avatarImg').src = fr.result;
    const email = localStorage.getItem('capu_current');
    users[email].avatar = fr.result;
    localStorage.setItem('capu_users', JSON.stringify(users));
  };
  fr.readAsDataURL(f);
});
$('avatarWrap').addEventListener('click', ()=>$('avatarFile').click());

// PANEL DE ESTILOS
$('openPanelHeader').addEventListener('click', ()=> $('editPanel').classList.toggle('hidden'));

// FONDO
let stagedBg = {img:null,color:null};
$('bgFile').addEventListener('change', ev => {
  const f = ev.target.files[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = () => { stagedBg.img = fr.result; alert('Imagen cargada. Vista previa o Aplicar.'); };
  fr.readAsDataURL(f);
});
$('bgColor').addEventListener('input', ev => stagedBg.color = ev.target.value);
$('previewBg').addEventListener('click', () => {
  if(stagedBg.img) $('landing-wrap').style.backgroundImage=`url('${stagedBg.img}')`;
  else if(stagedBg.color) $('landing-wrap').style.background = stagedBg.color;
});
$('applyBg').addEventListener('click', () => {
  if(stagedBg.img){ localStorage.setItem('capu_bg', stagedBg.img); $('landing-wrap').style.backgroundImage=`url('${stagedBg.img}')`; }
  else if(stagedBg.color){ localStorage.setItem('capu_bg_color', stagedBg.color); $('landing-wrap').style.background=stagedBg.color; }
});
$('clearBg').addEventListener('click', () => {
  localStorage.removeItem('capu_bg'); localStorage.removeItem('capu_bg_color');
  $('landing-wrap').style.background='linear-gradient(180deg,#fffaf6,#fff1e6)'; $('landing-wrap').style.backgroundImage='';
  stagedBg={img:null,color:null}; $('bgFile').value=''; $('bgColor').value='#ffffff';
});
$('saveStyles').addEventListener('click', ()=>alert('Estilos guardados en tu navegador. Pulsa Aplicar.'));
$('resetStyles').addEventListener('click', ()=>{ localStorage.removeItem('capu_bg'); localStorage.removeItem('capu_bg_color'); location.reload(); });

// CARGAR APP
window.addEventListener('load', ()=>{
  const bg = localStorage.getItem('capu_bg'); 
  const bgc = localStorage.getItem('capu_bg_color');
  if(bg) $('landing-wrap').style.backgroundImage=`url('${bg}')`;
  if(bgc) $('landing-wrap').style.background=bgc;
  if(localStorage.getItem('capu_current')) initApp();
});

// LOGOUT BUTTON
$('logoutBtn').addEventListener('click', logout);
</script>
