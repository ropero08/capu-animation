<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CAPU Animation</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#5b3f5b;
      --muted:#6b6464;
      --card:#ffffff;
      --soft-bg: rgba(255,255,255,0.92);
      --accent1:#f5d6e6;
      --accent2:#e8f2fb;
      --round:14px;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Roboto,Arial;color:var(--primary);background:linear-gradient(180deg,#fffaf6,#fff1e6);}
    input,textarea,button{font-family:'Poppins',system-ui,Roboto,Arial;}
    input:focus, textarea:focus, button:focus { outline: 3px solid rgba(165,122,166,0.12); outline-offset:3px }

    /* LANDING */
    #landing-wrap{position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#fffaf6,#fff1e6);}
    #landing-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.18));backdrop-filter: blur(3px);}
    .card-join{position:relative; z-index:2; width:92%; max-width:480px; padding:36px; border-radius:18px; background:var(--soft-bg); box-shadow:0 18px 50px rgba(20,10,30,0.12); text-align:center;}
    .title{font-family:'Playfair Display',serif;font-size:42px;color:var(--primary);margin:0 0 6px 0}
    .lead{color:var(--muted);margin-bottom:16px;font-size:15px}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #efe6ee;margin-top:10px;font-size:15px}
    .btn{display:inline-block;padding:12px 20px;border-radius:12px;background:linear-gradient(180deg,var(--accent1),#f1cfe1);border:none;font-weight:600;cursor:pointer;color:#3a233a;margin-top:14px;box-shadow:0 8px 22px rgba(100,60,100,0.08)}
    .btn:hover{transform:translateY(-3px)}
    .small-tip{font-size:13px;color:var(--muted);margin-top:12px}

    /* APP HEADER */
    header.app-header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(255,255,255,0.95);position:sticky;top:0;z-index:60;backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(20,10,30,0.04)}
    .logo-left{display:flex;align-items:center;gap:12px}
    .logo-text{font-weight:700;font-size:20px;color:var(--primary);font-family:'Playfair Display',serif}
    .user-area{display:flex;align-items:center;gap:12px}
    .username{font-weight:600;color:var(--muted);font-size:14px}
    .avatar{width:50px;height:50px;border-radius:50%;overflow:hidden;border:2px solid rgba(0,0,0,0.06);cursor:pointer}
    .avatar img{width:100%;height:100%;object-fit:cover}

    /* MAIN APP */
    .container{max-width:1100px;margin:22px auto;padding:0 18px}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(20,10,30,0.04)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    /* Distribution */
    .dist{padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),#fff);min-height:260px;display:flex;flex-direction:column;gap:10px}
    .dist .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dist h3{margin:0;font-size:18px}
    .desc{flex:1;margin-top:8px;padding:10px;border-radius:10px;border:1px solid #f0e7f1;min-height:70px;resize:vertical}
    .file-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .file-row label{background:#fff;border:1px solid #efe6ee;padding:8px 10px;border-radius:10px;cursor:pointer}
    .preview{margin-top:8px;border-radius:10px;overflow:hidden;background:#faf7fb;padding:8px;border:1px dashed #efe6ee}
    .preview video,.preview iframe,.preview img{width:100%;height:auto;display:block;border-radius:8px}

    /* Gallery */
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}

    /* Edit panel */
    .edit-panel{position:fixed;right:18px;bottom:18px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 36px rgba(20,10,40,0.08);width:260px;z-index:80;transition:transform .18s ease,opacity .18s ease}
    .edit-panel.hidden{transform:translateY(18px);opacity:0.02;pointer-events:none}
    .edit-panel input[type=color], .edit-panel input[type=file]{display:block;margin:8px 0;width:100%}
    .edit-panel .tiny{font-size:13px;color:var(--muted);margin-top:6px}
    .small-btn{padding:8px 10px;border-radius:10px;border:1px solid #efe6ee;background:#fff;cursor:pointer}

    /* footer */
    .footer{text-align:center;color:var(--muted);padding:28px 0}
  </style>
</head>
<body>

  <!-- LANDING / REGISTER -->
  <div id="landing-wrap" role="banner">
    <div id="landing-overlay" aria-hidden="true"></div>
    <div class="card-join" role="main">
      <div class="title">CAPU ANIMATION</div>
      <div class="lead">Comparte animaciones, formaciÃ³n y devociÃ³n en tonos delicados</div>

      <form id="registerForm" aria-label="Formulario de registro">
        <input id="regName" class="input" type="text" placeholder="Tu nombre completo" required aria-label="Nombre">
        <input id="regEmail" class="input" type="email" placeholder="Tu correo" required aria-label="Correo">
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
          <button class="btn" type="submit">Crear cuenta / Entrar</button>
        </div>
      </form>
      <div class="small-tip">Personaliza el fondo desde el panel ðŸŽ¨</div>
    </div>
  </div>

  <!-- APP header -->
  <header class="app-header" id="appHeader" style="display:none">
    <div class="logo-left"><div class="logo-text">CAPU <span style="color:#a57aa6">Animation</span></div></div>
    <div class="user-area">
      <div class="username" id="displayName"></div>
      <div class="avatar" id="avatarWrap" title="Cambiar foto de perfil"><img id="avatarImg" src="https://via.placeholder.com/120?text=U" alt="avatar"></div>
      <button id="logoutBtn" class="small-btn">Salir</button>
    </div>
    <button id="openPanelHeader" class="small-btn">ðŸŽ¨</button>
  </header>

  <!-- MAIN APP -->
  <main id="appMain" style="display:none">
    <div class="container">

      <section class="card">
        <h2>Bienvenid@, <span id="welcomeName" style="font-weight:700"></span></h2>
        <p style="color:var(--muted)">Crea distribuciones, sube video y PDF y verÃ¡s una vista previa inmediata.</p>
      </section>

      <section class="card">
        <h3>Secciones principales</h3>
        <div class="grid" id="distsContainer"></div>
      </section>

      <section class="card">
        <h3>GalerÃ­a / Recursos</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="resourceUrl" class="input" placeholder="Pegar URL pÃºblica (imagen, video, PDF)">
          <select id="resourceType" style="padding:10px;border-radius:10px">
            <option value="auto">Detectar</option>
            <option value="image">Imagen</option>
            <option value="video">Video</option>
            <option value="pdf">PDF</option>
          </select>
          <button class="btn" id="addResourceBtn">AÃ±adir</button>
        </div>
        <div id="gallery" class="gallery-grid" aria-live="polite"></div>
      </section>

      <footer class="footer">CAPU Animation â€” Guardado en tu navegador</footer>
    </div>
  </main>

  <!-- EDIT PANEL -->
  <div class="edit-panel hidden" id="editPanel">
    <div style="font-weight:700">ðŸŽ¨ Personalizar</div>
    <div class="tiny">Fondo de registro / pÃ¡gina</div>
    <input type="file" id="bgFile" accept="image/*">
    <div class="tiny">Color de fondo</div>
    <input type="color" id="bgColor" value="#ffffff">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="small-btn" id="applyBg">Aplicar</button>
      <button class="small-btn" id="previewBg">Vista previa</button>
      <button class="small-btn" id="clearBg">Quitar</button>
    </div>
    <hr style="margin:8px 0">
    <div class="tiny">Avatar (perfil)</div>
    <input type="file" id="avatarFile" accept="image/*">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="small-btn" id="saveStyles">Guardar</button>
      <button class="small-btn" id="resetStyles">Reset</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-top:8px">Los cambios se guardan en tu navegador. Pulsa "Aplicar" para que afecte registro y principal.</div>
  </div>

<script>
const $=id=>document.getElementById(id);

/* ------------------ LOGIN / REGISTER ------------------ */
function doRegister(e){
  e.preventDefault();
  const name=$.regName.value.trim(), email=$.regEmail.value.trim();
  if(!name||!email) return alert('Completa nombre y correo');
  let users=JSON.parse(localStorage.getItem('capu_users')||'{}');
  if(!users[email]) users[email]={name,email,avatar:null,dists:[]};
  localStorage.setItem('capu_users',JSON.stringify(users));
  localStorage.setItem('capu_current',email);
  initApp();
}
$.registerForm?.addEventListener('submit',doRegister);

/* ------------------ INIT APP ------------------ */
function initApp(){
  const email=localStorage.getItem('capu_current');
  if(!email) return;
  const users=JSON.parse(localStorage.getItem('capu_users')||'{}');
  const user=users[email];
  if(!user) return;

  $.landing-wrap.style.display='none';
  $.appHeader.style.display='';
  $.appMain.style.display='';

  $.welcomeName.textContent=user.name;
  $.displayName.textContent=user.name;
  $.avatarImg.src=user.avatar||'https://via.placeholder.com/120?text=U';

  renderDists();
  renderGallery();
}

/* ------------------ LOGOUT ------------------ */
$.logoutBtn?.addEventListener('click',()=>{
  localStorage.removeItem('capu_current');
  location.reload();
});

/* ------------------ EDIT PANEL ------------------ */
let stagedBg={img:null,color:null};
$.openPanelHeader?.addEventListener('click',()=>$.editPanel.classList.toggle('hidden'));
$.bgFile?.addEventListener('change',ev=>{
  const f=ev.target.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=()=>{stagedBg.img=fr.result; alert('Imagen cargada, pulsa aplicar');};
  fr.readAsDataURL(f);
});
$.bgColor?.addEventListener('input',ev=>stagedBg.color=ev.target.value);
$.previewBg?.addEventListener('click',()=>{
  if(stagedBg.img) $.landing-wrap.style.backgroundImage=`url('${stagedBg.img}')`;
  else if(stagedBg.color) $.landing-wrap.style.background=stagedBg.color;
  else alert('Selecciona imagen o color');
});
$.applyBg?.addEventListener('click',()=>{
  if(stagedBg.img) localStorage.setItem('capu_bg',stagedBg.img);
  if(stagedBg.color) localStorage.setItem('capu_bg_color',stagedBg.color);
  alert('Fondo aplicado y guardado');
});
$.clearBg?.addEventListener('click',()=>{
  localStorage.removeItem('capu_bg'); localStorage.removeItem('capu_bg_color');
  $.landing-wrap.style.background='linear-gradient(180deg,#fffaf6,#fff1e6)';
  $.landing-wrap.style.backgroundImage='';
  stagedBg={img:null,color:null};
  $.bgFile.value=''; $.bgColor.value='#ffffff';
  alert('Fondo restablecido');
});

/* ------------------ AVATAR ------------------ */
$.avatarFile?.addEventListener('change',ev=>{
  const f=ev.target.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=()=>{
    $.avatarImg.src=fr.result;
    const email=localStorage.getItem('capu_current');
    let users=JSON.parse(localStorage.getItem('capu_users')||'{}');
    users[email].avatar=fr.result;
    localStorage.setItem('capu_users',JSON.stringify(users));
  };
});
$.avatarWrap?.addEventListener('click',()=>$.avatarFile.click());

/* ------------------ DISTRIBUTIONS ------------------ */
function renderDists(){
  const cont=$.distsContainer; cont.innerHTML='';
  const email=localStorage.getItem('capu_current');
  let users=JSON.parse(localStorage.getItem('capu_users')||'{}');
  const user=users[email];
  if(!user.dists.length) user.dists=[{title:'SecciÃ³n 1',text:'',media:[]},{title:'SecciÃ³n 2',text:'',media:[]},{title:'SecciÃ³n 3',text:'',media:[]}];

  user.dists.forEach((d,idx)=>{
    const box=document.createElement('div'); box.className='dist';
    box.innerHTML=`
      <div class="hdr"><h3 contenteditable="true" class="dist-title">${d.title}</h3></div>
      <textarea class="desc" placeholder="DescripciÃ³n...">${d.text||''}</textarea>
      <div class="file-row">
        <label>Subir video <input type="file" accept="video/*" style="display:none" class="video-up"></label>
        <label>Subir PDF <input type="file" accept="application/pdf" style="display:none" class="pdf-up"></label>
        <button class="small-btn save-dist">Guardar</button>
      </div>
      <div class="preview"></div>
    `;
    cont.appendChild(box);

    const videoUp=box.querySelector('.video-up');
    const pdfUp=box.querySelector('.pdf-up');
    const preview=box.querySelector('.preview');
    const saveBtn=box.querySelector('.save-dist');

    function paintMedia(){
      preview.innerHTML='';
      (d.media||[]).forEach(m=>{
        if(m.type==='video'){ const v=document.createElement('video'); v.controls=true; v.src=m.url; v.style.width='100%'; preview.appendChild(v);}
        if(m.type==='pdf'){ const iframe=document.createElement('iframe'); iframe.src=m.url; iframe.style.width='100%'; iframe.style.height='300px'; preview.appendChild(iframe);}
      });
    }
    paintMedia();

    videoUp.addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const url=URL.createObjectURL(f); d.media=d.media||[]; d.media.push({type:'video',url}); saveAndRerender();
    });
    pdfUp.addEventListener('change',ev=>{
      const f=ev.target.files[0]; if(!f) return;
      const url=URL.createObjectURL(f); d.media=d.media||[]; d.media.push({type:'pdf',url}); saveAndRerender();
    });

    saveBtn.addEventListener('click',()=>{
      d.title=box.querySelector('.dist-title').textContent.trim();
      d.text=box.querySelector('.desc').value.trim();
      saveAndRerender();
      alert('SecciÃ³n guardada');
    });

    function saveAndRerender(){
      user.dists[idx]=d;
      users[email]=user;
      localStorage.setItem('capu_users',JSON.stringify(users));
      renderDists();
    }
  });
  users[email]=user;
  localStorage.setItem('capu_users',JSON.stringify(users));
}

/* ------------------ GALLERY ------------------ */
function detectType(url){
  if(/\.(jpg|jpeg|png|gif|webp)$/i.test(url)) return 'image';
  if(/\.(mp4|webm|ogg)$/i.test(url)) return 'video';
  if(/\.pdf$/i.test(url)) return 'pdf';
  return 'image';
}
$.addResourceBtn?.addEventListener('click',()=>{
  const url=$.resourceUrl.value.trim(); if(!url) return alert('Pega una URL vÃ¡lida');
  let type=$.resourceType.value;
  if(type==='auto') type=detectType(url);
  const email=localStorage.getItem('capu_current');
  let users=JSON.parse(localStorage.getItem('capu_users')||'{}');
  const user=users[email];
  user.gallery=user.gallery||[];
  user.gallery.unshift({url,type});
  users[email]=user;
  localStorage.setItem('capu_users',JSON.stringify(users));
  renderGallery();
  $.resourceUrl.value='';
});
function renderGallery(){
  const g=$.gallery; g.innerHTML='';
  const email=localStorage.getItem('capu_current');
  let users=JSON.parse(localStorage.getItem('capu_users')||'{}');
  const user=users[email];
  if(!user.gallery) user.gallery=[];
  user.gallery.forEach((it,idx)=>{
    const card=document.createElement('div'); card.style.background='#fff'; card.style.padding='8px'; card.style.borderRadius='10px'; card.style.boxShadow='0 10px 30px rgba(0,0,0,0.05)';
    if(it.type==='image') card.innerHTML=`<img src="${it.url}" style="width:100%;border-radius:8px">`;
    else if(it.type==='video') card.innerHTML=`<video controls src="${it.url}" style="width:100%;border-radius:8px"></video>`;
    else if(it.type==='pdf') card.innerHTML=`<a href="${it.url}" target="_blank">Abrir PDF</a>`;
    const del=document.createElement('button'); del.className='small-btn'; del.textContent='Eliminar'; del.style.marginTop='8px';
    del.addEventListener('click',()=>{ user.gallery.splice(idx,1); users[email]=user; localStorage.setItem('capu_users',JSON.stringify(users)); renderGallery(); });
    card.appendChild(del);
    g.appendChild(card);
  });
}

/* ------------------ SEARCH ------------------ */
$.searchInput?.addEventListener('input',function(){
  const q=this.value.toLowerCase();
  document.querySelectorAll('.dist').forEach(div=>{
    const title=div.querySelector('.dist-title')?.textContent?.toLowerCase()||'';
    const desc=div.querySelector('.desc')?.value?.toLowerCase()||'';
    div.style.display=(title+desc).includes(q)?'flex':'none';
  });
});

/* ------------------ LOAD ------------------ */
window.addEventListener('load',()=>{
  const bg=localStorage.getItem('capu_bg');
  const bgc=localStorage.getItem('capu_bg_color');
  if(bg) $.landing-wrap.style.backgroundImage=`url('${bg}')`;
  if(bgc) $.landing-wrap.style.background=bgc;
  if(localStorage.getItem('capu_current')) initApp();
});
</script>
</body>
</html>
